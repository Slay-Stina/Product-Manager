@page "/products"
@using Product_Manager.Data
@using Product_Manager.Services
@using Product_Manager.Models
@implements IDisposable
@inject ProductCrawlerService CrawlerService
@inject BrandConfigService BrandConfigService
@inject CrawlerSettings CrawlerSettings
@inject ILogger<Products> Logger
@rendermode InteractiveServer

<PageTitle>🛒 Products</PageTitle>

<h1>🛒 Products</h1>

<div style="margin-bottom: 20px;">
    <FluentButton Appearance="Appearance.Accent" OnClick="StartCrawler" Disabled="@isRunning">
        @(isRunning ? "🕷️ Crawling..." : "🚀 Start Crawler")
    </FluentButton>
    
    <FluentButton Appearance="Appearance.Neutral" OnClick="LoadProducts" style="margin-left: 10px;" Disabled="@isRunning">
        🔄 Refresh Products
    </FluentButton>
</div>

@if (!string.IsNullOrEmpty(statusMessage))
{
    <FluentMessageBar Title="📊 Status" Intent="@messageIntent" style="margin-bottom: 20px;">
        @statusMessage
    </FluentMessageBar>
}

@if (products == null)
{
    <FluentProgressRing>⏳ Loading...</FluentProgressRing>
}
else if (!products.Any())
{
    <p>📦 No products found. Use the crawler to fetch product data.</p>
}
else
{
    <FluentDataGrid Id="productsgrid" Items="@products" GridTemplateColumns="1fr 1fr 1fr 2fr 100px" TGridItem="Product">
        <PropertyColumn Title="Article Number" Property="@(p => p!.ArticleNumber)" Align="Align.Start"/>
        <PropertyColumn Title="Color ID" Property="@(p => p!.ColorId)" Align="Align.Start"/>
        <PropertyColumn Title="Description" Property="@(p => p!.Description)" Align="Align.Start"/>
        <PropertyColumn Title="Created" Property="@(p => p!.CreatedAt)" Format="yyyy-MM-dd" Align="Align.Start"/>
        <TemplateColumn Title="Image" Align="Align.Center">
            @if (context.ImageData != null)
            {
                <img src="@($"data:image/jpeg;base64,{Convert.ToBase64String(context.ImageData)}")" 
                     alt="Product" 
                     style="max-width: 80px; max-height: 80px;" />
            }
            else if (!string.IsNullOrEmpty(context.ImageUrl))
            {
                <img src="@context.ImageUrl" 
                     alt="Product" 
                     style="max-width: 80px; max-height: 80px;" />
            }
            else
            {
                <span>🚫 No image</span>
            }
        </TemplateColumn>
    </FluentDataGrid>
    
    <p style="margin-top: 10px;">📊 Total products: @products.Count()</p>
}

@code {
    private IQueryable<Product>? products;
    private bool isRunning = false;
    private string? statusMessage;
    private MessageIntent messageIntent = MessageIntent.Info;
    private bool _disposed = false;

    protected override async Task OnInitializedAsync()
    {
        await LoadProducts();
    }

    private async Task LoadProducts()
    {
        try
        {
            var productList = await CrawlerService.GetAllProductsAsync();
            products = productList.AsQueryable();
            Logger.LogInformation("✅ Loaded {Count} products", productList.Count);
            
            // Safely update UI
            await InvokeAsync(StateHasChanged);
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "❌ Error loading products");
            statusMessage = $"❌ Error loading products: {ex.Message}";
            messageIntent = MessageIntent.Error;
            
            // Safely update UI
            await InvokeAsync(StateHasChanged);
        }
    }

    private async Task StartCrawler()
    {
        if (_disposed) return;
        
        isRunning = true;
        statusMessage = "🕷️ Starting crawler... This may take a few minutes. ⏳";
        messageIntent = MessageIntent.Info;
        await InvokeAsync(StateHasChanged);

        try
        {
            // Try to find a matching brand config based on the current target URL
            Logger.LogInformation("🔍 Looking for brand config matching URL: {Url}", CrawlerSettings.TargetUrl);
            
            var allConfigs = await BrandConfigService.GetAllConfigsAsync();
            Logger.LogInformation("📚 Found {Count} total brand configs", allConfigs.Count);
            
            BrandConfig? matchingConfig = null;
            
            if (!string.IsNullOrWhiteSpace(CrawlerSettings.TargetUrl))
            {
                try
                {
                    var targetUri = new Uri(CrawlerSettings.TargetUrl);
                    var targetHost = targetUri.Host;
                    
                    Logger.LogInformation("🎯 Target host: {Host}", targetHost);
                    
                    foreach (var config in allConfigs.Where(c => !string.IsNullOrWhiteSpace(c.TargetUrl)))
                    {
                        try
                        {
                            var configUri = new Uri(config.TargetUrl);
                            var configHost = configUri.Host;
                            Logger.LogInformation("🔍 Checking config '{BrandName}' with host: {Host}", config.BrandName, configHost);
                            
                            if (targetHost.Equals(configHost, StringComparison.OrdinalIgnoreCase))
                            {
                                matchingConfig = config;
                                Logger.LogInformation("✅ Found match: {BrandName}", config.BrandName);
                                break;
                            }
                        }
                        catch (Exception ex)
                        {
                            Logger.LogWarning(ex, "⚠ Error parsing config URL for {BrandName}", config.BrandName);
                        }
                    }
                }
                catch (Exception ex)
                {
                    Logger.LogError(ex, "❌ Error parsing target URL");
                }
            }
            
            if (matchingConfig != null)
            {
                Logger.LogInformation("📋 Applying brand config: {BrandName}", matchingConfig.BrandName);
                CrawlerService.SetBrandConfig(matchingConfig);
                statusMessage = $"🕷️ Using {matchingConfig.BrandName} configuration. Starting crawler...";
                if (!_disposed) await InvokeAsync(StateHasChanged);
                await Task.Delay(500); // Give UI time to update
            }
            else
            {
                Logger.LogWarning("⚠️ No matching brand config found for {Url}", CrawlerSettings.TargetUrl);
                statusMessage = "⚠️ No brand config found. Using generic selectors...";
                if (!_disposed) await InvokeAsync(StateHasChanged);
                await Task.Delay(500);
            }
            
            await CrawlerService.StartCrawlingAsync();
            
            if (_disposed) return;
            
            statusMessage = "✅ Crawling completed successfully! 🎉";
            messageIntent = MessageIntent.Success;
            
            await LoadProducts();
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "❌ Error during crawling");
            statusMessage = $"❌ Error during crawling: {ex.Message}";
            messageIntent = MessageIntent.Error;
        }
        finally
        {
            isRunning = false;
            await InvokeAsync(StateHasChanged);
        }
    }

    public void Dispose()
    {
        _disposed = true;
    }
}

