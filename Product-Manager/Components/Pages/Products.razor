@page "/products"
@using Product_Manager.Data
@using Product_Manager.Services
@using Product_Manager.Models
@implements IDisposable
@inject ProductCrawlerService CrawlerService
@inject ProductRepository ProductRepository
@inject BrandConfigService BrandConfigService
@inject CrawlerSettings CrawlerSettings
@inject ILogger<Products> Logger
@rendermode InteractiveServer

<PageTitle>🛒 Products</PageTitle>

<h1>🛒 Products</h1>

<div style="margin-bottom: 20px;">
    <FluentButton Appearance="Appearance.Accent" OnClick="StartCrawler" Disabled="@isRunning">
        @(isRunning ? "🕷️ Crawling..." : "🚀 Start Crawler")
    </FluentButton>
    
    <FluentButton Appearance="Appearance.Neutral" OnClick="LoadProducts" style="margin-left: 10px;" Disabled="@isRunning">
        🔄 Refresh Products
    </FluentButton>
</div>

@if (!string.IsNullOrEmpty(statusMessage))
{
    <FluentMessageBar Title="📊 Status" Intent="@messageIntent" style="margin-bottom: 20px;">
        @statusMessage
    </FluentMessageBar>
}

@if (products == null)
{
    <FluentProgressRing>⏳ Loading...</FluentProgressRing>
}
else if (!products.Any())
{
    <p>📦 No products found. Use the crawler to fetch product data.</p>
}
else
{
    <FluentDataGrid Id="productsgrid" Items="@products" GridTemplateColumns="1fr 1fr 0.5fr 1fr 2fr 1fr 1.5fr 150px" TGridItem="Product">
        <PropertyColumn Title="Article Number" Property="@(p => p!.ArticleNumber)" Align="Align.Start"/>
        <PropertyColumn Title="EAN" Property="@(p => p!.EAN)" Align="Align.Start"/>
        <PropertyColumn Title="Color ID" Property="@(p => p!.ColorId)" Align="Align.Start"/>
        <PropertyColumn Title="Price" Property="@(p => p!.Price)" Format="C2" Align="Align.Start"/>
        <PropertyColumn Title="Description" Property="@(p => p!.Description)" Align="Align.Start"/>
        <PropertyColumn Title="Created" Property="@(p => p!.CreatedAt)" Format="yyyy-MM-dd" Align="Align.Start"/>
        <TemplateColumn Title="Product URL" Align="Align.Start">
            @{
                var isValidUrl = !string.IsNullOrEmpty(context.ProductUrl)
                    && Uri.TryCreate(context.ProductUrl, UriKind.Absolute, out var productUri)
                    && (productUri.Scheme == Uri.UriSchemeHttp || productUri.Scheme == Uri.UriSchemeHttps);
            }
            @if (isValidUrl)
            {
                <a href="@context.ProductUrl" target="_blank" rel="noopener noreferrer" title="@context.ProductUrl" style="color: #0078d4; text-decoration: none;">
                    🔗 View
                </a>
            }
            else
            {
                <span style="color: #999;">-</span>
            }
        </TemplateColumn>
        <TemplateColumn Title="Images" Align="Align.Center">
            @if (context.Images?.Any() == true)
            {
                <div style="display: flex; gap: 5px; flex-wrap: wrap; justify-content: center;">
                    @foreach (var image in context.Images.OrderBy(i => i.Order).Take(3))
                    {
                        @if (image.ImageData != null)
                        {
                            var mimeType = DetectImageMimeType(image.ImageData);
                            <img src="@($"data:{mimeType};base64,{Convert.ToBase64String(image.ImageData)}")" 
                                 alt="Product" 
                                 style="max-width: 60px; max-height: 60px; border: 1px solid #ddd; border-radius: 4px;"
                                 title="@(image.IsPrimary ? "Primary Image" : $"Image {image.Order + 1}")" />
                        }
                        else if (!string.IsNullOrEmpty(image.ImageUrl))
                        {
                            <img src="@image.ImageUrl" 
                                 alt="Product" 
                                 style="max-width: 60px; max-height: 60px; border: 1px solid #ddd; border-radius: 4px;"
                                 title="@(image.IsPrimary ? "Primary Image" : $"Image {image.Order + 1}")" />
                        }
                    }
                    @if (context.Images.Count > 3)
                    {
                        <span style="display: flex; align-items: center; color: #666; font-size: 0.9em;">
                            +@(context.Images.Count - 3) more
                        </span>
                    }
                </div>
            }
            else
            {
                <span>🚫 No image</span>
            }
        </TemplateColumn>
    </FluentDataGrid>

    <p style="margin-top: 10px;">📊 Total products: @products.Count()</p>
}

@code {
    private IQueryable<Product>? products;
    private bool isRunning = false;
    private string? statusMessage;
    private MessageIntent messageIntent = MessageIntent.Info;
    private bool _disposed = false;

    protected override async Task OnInitializedAsync()
    {
        await LoadProducts();
    }

    private async Task LoadProducts()
    {
        try
        {
            var productList = await ProductRepository.GetAllProductsAsync();
            products = productList.AsQueryable();
            Logger.LogInformation("✅ Loaded {Count} products", productList.Count);

            // Safely update UI
            await InvokeAsync(StateHasChanged);
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "❌ Error loading products");
            statusMessage = $"❌ Error loading products: {ex.Message}";
            messageIntent = MessageIntent.Error;

            // Safely update UI
            await InvokeAsync(StateHasChanged);
        }
    }

    private async Task StartCrawler()
    {
        if (_disposed) return;
        
        isRunning = true;
        statusMessage = "🕷️ Starting crawler... This may take a few minutes. ⏳";
        messageIntent = MessageIntent.Info;
        await InvokeAsync(StateHasChanged);

        try
        {
            // Try to find a matching brand config based on the current target URL
            Logger.LogInformation("🔍 Looking for brand config matching URL: {Url}", CrawlerSettings.TargetUrl);
            
            var allConfigs = await BrandConfigService.GetAllConfigsAsync();
            Logger.LogInformation("📚 Found {Count} total brand configs", allConfigs.Count);
            
            BrandConfig? matchingConfig = null;
            
            if (!string.IsNullOrWhiteSpace(CrawlerSettings.TargetUrl))
            {
                try
                {
                    var targetUri = new Uri(CrawlerSettings.TargetUrl);
                    var targetHost = targetUri.Host;
                    
                    Logger.LogInformation("🎯 Target host: {Host}", targetHost);
                    
                    foreach (var config in allConfigs.Where(c => !string.IsNullOrWhiteSpace(c.TargetUrl)))
                    {
                        try
                        {
                            var configUri = new Uri(config.TargetUrl);
                            var configHost = configUri.Host;
                            Logger.LogInformation("🔍 Checking config '{BrandName}' with host: {Host}", config.BrandName, configHost);
                            
                            if (targetHost.Equals(configHost, StringComparison.OrdinalIgnoreCase))
                            {
                                matchingConfig = config;
                                Logger.LogInformation("✅ Found match: {BrandName}", config.BrandName);
                                break;
                            }
                        }
                        catch (Exception ex)
                        {
                            Logger.LogWarning(ex, "⚠ Error parsing config URL for {BrandName}", config.BrandName);
                        }
                    }
                }
                catch (Exception ex)
                {
                    Logger.LogError(ex, "❌ Error parsing target URL");
                }
            }
            
            if (matchingConfig != null)
            {
                Logger.LogInformation("📋 Applying brand config: {BrandName}", matchingConfig.BrandName);
                CrawlerService.SetBrandConfig(matchingConfig);
                statusMessage = $"🕷️ Using {matchingConfig.BrandName} configuration. Starting crawler...";
                if (!_disposed) await InvokeAsync(StateHasChanged);
                await Task.Delay(500); // Give UI time to update
            }
            else
            {
                Logger.LogWarning("⚠️ No matching brand config found for {Url}", CrawlerSettings.TargetUrl);
                statusMessage = "⚠️ No brand config found. Using generic selectors...";
                if (!_disposed) await InvokeAsync(StateHasChanged);
                await Task.Delay(500);
            }
            
            await CrawlerService.StartCrawlingAsync();
            
            if (_disposed) return;
            
            statusMessage = "✅ Crawling completed successfully! 🎉";
            messageIntent = MessageIntent.Success;
            
            await LoadProducts();
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "❌ Error during crawling");
            statusMessage = $"❌ Error during crawling: {ex.Message}";
            messageIntent = MessageIntent.Error;
        }
        finally
        {
            isRunning = false;
            if (!_disposed)
            {
                try
                {
                    await InvokeAsync(StateHasChanged);
                }
                catch (ObjectDisposedException ex)
                {
                    // Component was disposed during the crawl; this is expected if user navigates away
                    Logger.LogDebug(ex, "Component disposed during state update");
                }
            }
        }
    }

    public void Dispose()
    {
        _disposed = true;
    }

    private static string DetectImageMimeType(byte[] data)
    {
        if (data == null || data.Length < 12)
            return "image/jpeg"; // Default fallback - need at least 12 bytes for WebP detection

        // JPEG: FF D8 FF
        if (data[0] == 0xFF && data[1] == 0xD8 && data[2] == 0xFF)
            return "image/jpeg";

        // PNG: 89 50 4E 47 0D 0A 1A 0A
        if (data.Length >= 8 &&
            data[0] == 0x89 && data[1] == 0x50 && data[2] == 0x4E && data[3] == 0x47 &&
            data[4] == 0x0D && data[5] == 0x0A && data[6] == 0x1A && data[7] == 0x0A)
            return "image/png";

        // GIF: "GIF"
        if (data[0] == (byte)'G' && data[1] == (byte)'I' && data[2] == (byte)'F')
            return "image/gif";

        // WebP: "RIFF" .... "WEBP"
        if (data[0] == (byte)'R' && data[1] == (byte)'I' && data[2] == (byte)'F' && data[3] == (byte)'F' &&
            data[8] == (byte)'W' && data[9] == (byte)'E' && data[10] == (byte)'B' && data[11] == (byte)'P')
            return "image/webp";

        return "image/jpeg"; // Default fallback
    }
}

